## 06、07 | 锁

MySQL 中的锁大致分为全局锁、表锁和行锁。



### 全局锁

全局锁就是对整个数据库实例加锁。



加全局锁命令：`Flush tables with read lock`（FTWRL），执行该命令会让整个库处于只读状态。

```sql
Flush tables with read lock;
```

使用场景： 做全库逻辑备份。



> 有了 MVCC 的支持，为什么还需要 FTWRL ?
>
> 一致性读是存储引擎提供的，但不是所有引擎都支持事务。



还有一种方式可以实现全库只读。

```sql
set global  read_only  = true;
```



但建议使用 FTWRL 来完成全库只读。原因如下：

- 在有些系统中， readonly 的值被用来做其他逻辑。如判断一个库是备库还是主库。
- 异常处理机制上存在差异。
  - 如果执行 FTWRL 命令之后由于客户端异常断开，MySQL 会自动释放这个全局锁。
  - 整库设置为 readonly 之后，如果客户端发生异常，则数据库会一直会保持 readonly 状态，风险较高。



### 表级锁

表锁一般是在数据库引擎不支持行锁的时候才会被用到的。



MySQL 中表级锁有两种：

- 表锁
- 元数据锁（meta data lock,MDL)



#### 表锁

语法: 

加锁：`lock table ... read/write；`

释放锁：

- 执行：`unlock tables;`

- 客户端断开时主动释放

```sql
-- 对 user 表加读锁
lock tables user read;
-- 对 userinfo 表加写锁
lock tables userinfo write;
-- 释放锁
unlock tables;
```



特点：

| 表锁类型 | 当前线程           | 其他线程           |
| -------- | ------------------ | ------------------ |
| 读锁     | 只能读取，不能修改 | 只能读取，不能修改 |
| 写锁     | 能读写             | 不能读，更不能写   |



#### MDL 锁

MDL 不需要显式使用，在访问一个表的时候会被自动加上。

作用：保证读写的正确性。用于隔离 DML 和 DDL 操作之间的干扰。

DML 操作需要加 MDL 读锁。

DDL 操作需要加 MDL 写锁。

加锁时机：**事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，而会等到整个事务提交后再释放**。







### 行锁



