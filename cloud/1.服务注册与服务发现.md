[TOC]
## 分类

Eureka：不在更新

Nacos：Alibaba 的 cloud 组件

## Eureka

### 工作细节

Eureka 本身可以分为两大部分，Eureka Server  和 Eureka Client 

#### Eureka Server

Eureka Server 对外主要提供了三个功能：

- **服务注册**：所有的服务器都注册到 Eureka Server。
- **服务发现**：Eureka Server 维护了一个服务清单，Eureka Client 在启动的时候，会发送一个 REST 请求，从 Eureka Server 上获取到一份只读清单，缓存到本地，并定期更新。
- **同步状态**：Eureka Client 通过注册、心跳等机制，与 Eureka Server 同步当前客户端状态。

还有其他功能：

- 失效剔除：有时候，由于内存溢出、网络故障等原因，使得服务不能正常工作，而注册中心并未收到 "服务下线" 的请求。为了剔除这些无法提供服务的实例，Eureka Server 在启动时会创建一个定时任务，默认每隔 60 秒 将当前清单中超时 （默认为 90 秒）没有续约的服务剔除。
- 自我保护：Eureka Server 在运行时，统计到和服务心跳失败比例在 15 分钟内低于 85%，则会触发自我保护机制，将当前实例注册信息保护起来，停止移除，停止同步，让这些实例不会过期。

```properties
# 关闭注册中心 自我保护机制
eureka.server.enable-self-preservation=false
```



#### Eureka Client

Eureka Client 主要用来简化和 Eureka Server 之间的交互，Eureka Client 会自动拉取、更新以及缓存 Eureka Server 中的信息，这样即使 Eureka Server 所有结点宕机，Eureka Cient 也能获取到想要调用的服务的地址（可能会不准确）。

##### 服务注册

“服务提供者” 在启动时候会发送 REST 请求将自己注册到 Eureka Server 上，同时带上来自身服务的一些元数据信息，如 IP、端口、名称、状态等。Eureka Server 会将元数据信息存储到一个双层结构 Map 中，其中第一层的 key 是服务名(AppName)，第二层的 key 是具体服务的实例名(InstanceInfo 中的instanceId 属性)。

com.netflix.eureka.registry.AbstractInstanceRegistry#register

```java
 private final ConcurrentHashMap<String, Map<String, Lease<InstanceInfo>>> registry = new ConcurrentHashMap<String, Map<String, Lease<InstanceInfo>>>();

Map<String, Lease<InstanceInfo>> gMap = registry.get(registrant.getAppName());
Lease<InstanceInfo> existingLease = gMap.get(registrant.getId());
```

服务注册相关属性：

```properties
# 将服务注册到注册中心
eureka.client.register-with-eureka=true
# 指定注册中心
eureka.client.service-url.defaultZone=http://eurekaB:8082/eureka
```



##### 服务续约（Renew）

在注册完服务之后，Eureka Client 会维持一个心态用来持续告诉 Eureka Server 我还在正常运行，以防止 Eureka Server 的 “剔除任务” 将该服务实例从服务列表排除出去。

服务续约相关属性（均为默认值,一般不建议修改）：

```properties
# 定义服务续约任务的调用间隔时间(秒)
eureka.instance.lease-renewal-interval-in-seconds=30
# 定义服务失效的时间(秒)
eureka.instance.lease-expiration-duration-in-seconds=90
```

Eureka Client 每隔 30 秒就要向 Eureka Server 发送一条心跳信息，如果 Eureka Server 连续 90 秒都没有收到 Eureka Client 的续约信息（连续三次没发送），就会触发 “剔除任务”，将掉线的 Eureka Client  从当前服务注册列表中剔除。

##### 获取服务

Eureka Client (Consumer) 在启动时，会向注册中心发送一个 REST 请求来获取注册中心上的服务清单，同时服务清单会每隔 30 秒更新一次。如果注册中心返回的服务清单信息换个本地缓存的服务清单信息不同的话，Consumer 会自动处理。

获取服务相关属性：

```properties
# 从注册中心缓存服务注册信息
eureka.client.fetch-registry=true
# 定期更新服务注册信息的时间(秒)
eureka.client.registry-fetch-interval-seconds=30
```



##### 服务调用

服务消费者在获取到服务清单后，通过服务名可以获得具体提供服务的实例名和该实例的元数据信息，然后根据客户端需要，决定调用哪个实例（客户端负载）。

对于访问实例的选择，Eureka 中有 Region 和 Zone 的概念，一个 Region中可以包含多个 Zone ,每个服务客户端需要被注册到一个 Zone 中，所以每个客户端对应一个 Region 和一个 Zone 。在进行服务调用的时候，优先访问同处一个 Zone中的服务提供方，若访问不到，就访问其他 Zone。



##### 服务下线

当服务实例进行正常的关闭操作时，会主动发送一个服务下线的 REST 请求给 Eureka Server，服务端在收到该请求后，将该服务实例状态置为下线（DOWN）,并把该下线事件传播出去。



### Eureka 集群原理

Eureka 集群架构图（官方）

![eureka_architecture](https://cdn.jsdelivr.net/gh/YangZhiqiang98/ImageBed/eureka_architecture.png)

在该集群架构中，Eureka Server 之间通过 Replicate 进行数据同步，不同的 Eureka Server 之间不区分主从节点，所有结点都是平等的。节点之间，通过制定 serviceUrl 互相注册，形成一个集群，进而提高节点的可用性。

在 Eureka Server 集群中，如果有某个节点宕机，Eureka Client 会自动切换到新的 Eureka Server 上。每一个Eureka Server 节点，都会互相同步数据。Eureka Server 的连接方式，可以是单线的,就是 A-->b-->C。此时, A 的数据也会和 C 之间互相同步。但是一般不建议这种写法，在我们配置 serviceUrl 时，可以指定多个注册地址,即 A 可以即注册到 B 上，也可以同时注册到 C 上。



### 配置参数

#### 服务注册类配置

`org.springframework.cloud.netflix.eureka.EurekaClientConfigBean` 中定义了常用的配置参数以及默认是，这些参数均以 eureka.client 为前缀。

| 参数名                                        | 说明                                                         | 默认值      |
| --------------------------------------------- | ------------------------------------------------------------ | ----------- |
| enabled                                       | 启用 Eureka 客户端                                           | true        |
| registryFetchIntervalSeconds                  | 从 Eureka 服务端获取注册信息的间隔时间，单位为秒             | 30          |
| instanceInfoReplicationIntervalSeconds        | 更新实例信息的变化到 Eureka 服务端的间隔时间，单位秒         | 30          |
| initialInstanceInfoReplicationIntervalSeconds | 初始化实例信息到 Eureka 服务端的间隔时间。单位为秒           | 40          |
| eurekaServiceUrlPollIntervalSeconds           | 轮询 Ereka 服务端地址更改的间隔时间，单位为秒。当与 Spring Config 配置，动态刷新 Eureka 的 serviceUrl 地址时需要关注该参数 | 5 * MINUTES |
| eurekaServerReadTimeoutSeconds                | 读取 Eureka Server 信息的超时时间，单位为秒                  | 90          |
| eurekaServerConnectTimeoutSeconds             | 连接Eureka Server 的超时时间，单位为秒                       | 5           |
| eurekaServerTotalConnections                  | 从 Eureka client 到所有 Eureka Server 的连接总数             | 200         |
| eurekaServerTotalConnectionsPerHost           | 从 Eureka 客户端到每个Eureka 服务器主机允许的连接总数        | 50          |
| eurekaConnectionIdleTimeoutSeconds            | Eureka 服务端连接的空闲关闭时间，单位秒                      | 30          |
| heartbeatExecutorThreadPoolSize               | 心跳连接池的初始化线程数                                     | 2           |
| heartbeatExecutorExponentialBackOffBound      | 心跳超时重试延迟时间的最大乘数值                             | 10          |
| cacheRefreshExecutorThreadPoolSize            | 缓存刷新线程池的初始化线程数                                 | 2           |
| cacheRefreshExecutorExponentialBackOffBound   | 缓存刷新重试延迟的最大乘数值                                 | 10          |
| useDnsForFetchingServiceUrls                  | 使用 DNS 来获取 Eureka 服务端的 serviceUrl                   | false       |
| registerWithEureka                            | 是否要将自身的实例信息注册到 Eureka 服务端                   | true        |
| preferSameZoneEureka                          | 是否偏好使用处于相同 Zone 的 Eureka 服务端                   | true        |
| filterOnlyUpInstances                         | 获取实例时是否过滤，仅保留 UP 状态的实例                     | true        |
| fetchRegistry                                 | 是否从 Eureka 服务端获取注册信息                             | true        |



#### 服务实例类配置

`org.springframework.cloud.netflix.eureka.EurekaInstanceConfigBean` 中定义了服务实例类的配置参数。

![image-20210904164653823](https://cdn.jsdelivr.net/gh/YangZhiqiang98/ImageBed/image-20210904164653823.png)

默认情况下，Eureka 中各个服务实例的健康状态并不是通过 spring-boot-actuator 模块的 /helath 端点来实现的，而是依靠客户端心跳的方式来保持服务实例的存活。默认的心跳实现方式可以有效检查客户端进行是否正常运行，但无法保证客户端应用能够正常提供服务。我们可以通过增加参数`eureka.client.healthcheck.enabled=true` 把 Eureka 客户端的健康检测交给 spring-boot-actuator 模块的 /helath 端点以实现更加全面的健康状态维护。



以下的配置信息都以 eureka.instance 为前缀

| 参数名                           | 说明                                                         | 默认值  |
| -------------------------------- | ------------------------------------------------------------ | ------- |
| preferIpAddress                  | 是否优先使用IP 地址作为主机名的标识                          | false   |
| leaseRenewalIntervalInSeconds    | Eureka 客户端向服务端发送心跳的时间间隔，单位为秒            | 30      |
| leaseExpirationDurationInSeconds | Eureka 服务端在收到最后一次心跳之后等待的时间上限，单位为秒。超过该时间之后服务端会将该服务实例从服务清单中剔除，从而进制服务调用请求被发送到该实例上 | 90      |
| nonSecurePort                    | 非安全的通信端口号                                           | 80      |
| securePort                       | 安全的通信端口号                                             | 443     |
| nonSecurePortEnabled             | 是否启用非安全的通信端口号                                   | true    |
| securePortEnabled                | 是否启用安全的通信端口号                                     |         |
| appname                          | 服务名，默认取 spring.application.name 的配置名，如果没有则为 UNKNOWN | UNKNOWN |
| hostname                         | 主机名，不配置的时候将根据操作系统的主机名来获取             |         |

