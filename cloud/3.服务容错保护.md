[TOC]

## 分类

Hystrix : 实现了断路器、线程隔离等一系列服务保护功能。具备服务降级、服务熔断、线程和信号隔离、请求缓存、请求合并以及服务监控等强大功能。





## 熔断器

[CircuitBreaker (martinfowler.com)](https://martinfowler.com/bliki/CircuitBreaker.html)

[服务容错模式 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/23711137)

熔断器模式可以防止我们的系统不断地尝试执行可能会失败的调用，使得我们的系统继续执行而不用等待修正错误，或者浪费 CPU 时间去等到长时间的超时产生。熔断器模式也可以使我们系统能够检测错误是否已经修正，如果已经修正，系统会再次尝试调用操作。下图是使用熔断器模式的调用流程：

![sketch](https://cdn.jsdelivr.net/gh/YangZhiqiang98/ImageBed/sketch.png)



可以从图中看出，当超时出现的次数达到一定条件后，熔断器会触发打开状态，客户端的下次调用将直接返回，不用等待超时产生。

在熔断器内部，往往有以下几种状态：

![state](https://cdn.jsdelivr.net/gh/YangZhiqiang98/ImageBed/state.png)



1）闭合（closed）状态：该状态下能够对目标服务或方法进行正常的调用。熔断器类维护了一个时间窗口内调用失败的次数，如果某次调用失败，则失败次数加 1。如果最近失败次数超过了在给定的时间窗口内允许失败的阈值(可以是数量也可以是比例)，则熔断器类切换到断开(Open)状态。此时熔断器设置了一个计时器，当时钟超过了该时间，则切换到半断开（Half-Open）状态，该睡眠时间的设定是给了系统一次机会来修正导致调用失败的错误。

2）断开(Open)状态：在该状态下，对目标服务或方法的请求会立即返回错误响应，如果设置了fallback方法，则会进入fallback的流程。

3）半断开（Half-Open）状态：允许对目标服务或方法的一定数量的请求可以去调用服务。如果这些请求对服务的调用成功，那么可以认为之前导致调用失败的错误已经修正，此时熔断器切换到闭合状态（并且将错误计数器重置）；如果这一定数量的请求有调用失败的情况，则认为导致之前调用失败的问题仍然存在，熔断器切回到断开方式，然后开始重置计时器来给系统一定的时间来修正错误。半断开状态能够有效防止正在恢复中的服务被突然而来的大量请求再次拖垮。



## Hystrix



[How it Works · Netflix/Hystrix Wiki (github.com)](https://github.com/Netflix/Hystrix/wiki/How-it-Works)

#### 容错原理

![hystrix-command-flow-chart](https://cdn.jsdelivr.net/gh/YangZhiqiang98/ImageBed/hystrix-command-flow-chart.png)



图中流程的说明:

1. 将远程服务调用逻辑封装进一个HystrixCommand。

2. 对于每次服务调用可以使用同步或异步机制，对应执行execute()或queue()。

3. 判断熔断器(circuit-breaker)是否打开或者半打开状态，如果打开跳到步骤8，进行回退策略，如果关闭进入步骤4。

4. 判断线程池/队列/信号量（使用了[舱壁隔离](https://zhuanlan.zhihu.com/p/23711137)模式）是否跑满，如果跑满进入回退步骤8，否则继续后续步骤5。

5. run方法中执行了实际的服务调用。

   a. 服务调用发生超时时，进入步骤8。

6. 判断run方法中的代码是否执行成功。

   a. 执行成功返回结果。

   b. 执行中出现错误则进入步骤8。

7. 所有的运行状态(成功，失败，拒绝，超时)上报给熔断器，用于统计从而影响熔断器状态。

8. 进入getFallback()回退逻辑。

   a. 没有实现getFallback()回退逻辑的调用将直接抛出异常。

   b. 回退逻辑调用成功直接返回。

   c. 回退逻辑调用失败抛出异常。

9. 返回执行成功结果。



熔断器模式往往应用于服务的自动降级，在实现上主要基于Netflix开源的组件Hystrix来实现，下图和代码分别是[Hystrix中熔断器的原理和定义](https://github.com/Netflix/Hystrix/wiki/How-it-Works)，更多了解可以查看Hystrix的源码：



```java
public interface HystrixCircuitBreaker {

    /**
     * Every {@link HystrixCommand} requests asks this if it is allowed to proceed or not.
     * <p>
     * This takes into account the half-open logic which allows some requests through when determining if it should be closed again.
     * 
     * @return boolean whether a request should be permitted
     */
    public boolean allowRequest();

    /**
     * Whether the circuit is currently open (tripped).
     * 
     * @return boolean state of circuit breaker
     */
    public boolean isOpen();

    /**
     * Invoked on successful executions from {@link HystrixCommand} as part of feedback mechanism when in a half-open state.
     */
    /* package */void markSuccess();
}
```







![circuit-breaker-1280](https://cdn.jsdelivr.net/gh/YangZhiqiang98/ImageBed/circuit-breaker-1280.png)



