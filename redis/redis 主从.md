### 主从架构

主服务器负责接收写请求，从服务器负责接收读请求，从服务器的数据由主服务器复制过去。主从服务器的数据是已知的。读写分离，保证高可用。

![主从架构](https://cdn.jsdelivr.net/gh/YangZhiqiang98/ImageBed/20211027063857.png)

### 复制功能

主从架构的特点之一：主服务器和从服务器的数据是一致的。

#### 复制功能的具体实现

复制功能分为两个操作：

- 同步（sync)
  - 将从服务器的数据库状态更新至主服务器的数据库状态
- 命令传播（command propagate）
  - 主服务器的数据库状态被修改，导致主从服务器的数据库状态不一致，让主从服务器的数据库状态重新回到一致状态。

从服务器对主服务器的同步又可以分为两种情况：

- 初次同步：从服务器没有复制过任何的主服务器，或者从服务器要复制的主服务器跟上次服务的主服务器不一样。
- 断线后同步：处于命令传播阶段的主从服务器因为网络原因中断了复制，从服务器通过自动重连重新连接主服务器，并继续复制主服务器。（2.8 版本 sync 命令，2.8之后 psync）

> sync 命令会把所有的数据再次同步，而不是只同步丢失的数据
>
> psync 命令具有**完整重同步和部分重同步**两种模式。

#### 完整重同步

- 从服务器向主服务器发送 PSYNC 命令
- 收到 PSYNC 命令的主服务器执行 BGSAVE 命令，在后台**生成一个 RDB 文件**。并用一个**缓冲区**来记录从现在开始执行的所有**写命令**。
- 当主服务器的 BGSAVE 命令执行完后，将生成的 RDB 文件发送给从服务器，**从服务器接收和载入 RBD 文件**。将自己的数据库状态更新至与主服务器执行 BGSAVE 命令时的状态。
- 主服务器将所有缓冲区的**写命令发送给从服务器**，从服务器执行这些写命令，达到数据最终一致性。

#### 部分重同步

部分重同步可以让我们断线后重连**只需要同步缺失的数据**。

部分重同步功能由以下部分组成：

- 主从服务器的**复制偏移量**
- 主服务器的**复制积压缓冲区**
- 服务器运行的 ID(**run ID**)

通过**对比主从复制的偏移量**，就很容易知道主从服务器的数据是否处于一致性的状态！

那断线重连以后，从服务器向主服务器发送 PSYNC 命令，报告现在的偏移量是 36，那么主服务器该对从服务器执行完整重同步还是部分重同步呢？这就交由**复制积压缓冲区**来决定。

当主服务器进行命令传播时，不仅仅会将写命令发送给所有的从服务器，还会将写命令**入队到复制积压缓冲区**里面(这个大小可以调的)。如果复制积压缓冲区**存在**丢失的偏移量的数据，那就执行部分重同步，否则执行完整重同步。

服务器运行的 ID(**run ID**) 实际上就是用来比对 ID 是否相同。如果不相同，则说明从服务器断线之前复制的主服务器和当前连接的主服务器是两台服务器，这就会进行完整重同步。

![PSYNC 执行](https://cdn.jsdelivr.net/gh/YangZhiqiang98/ImageBed/20211027064317.png)

### 参考资料

[1] https://mp.weixin.qq.com/s/6nBUoP2cid1Qn8XngDMjJw

[2] https://www.jianshu.com/p/f0e042b95249